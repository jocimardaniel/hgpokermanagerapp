<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPCA Poker Manager</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        /* Utilitários */
        .hidden { display: none !important; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Avatares e Badges */
        .avatar-circle { 
            width: 35px; height: 35px; border-radius: 50%; 
            background-color: #212529; color: #ffc107; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 0.9rem; border: 2px solid #dee2e6; 
        }
        .badge-cash { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .badge-torneio { background-color: #198754; color: white; }
        
        /* Configuração de Ranking (Tabelas Dinâmicas) */
        .table-config { font-size: 0.85rem; }
        .table-config input { padding: 0.25rem 0.4rem; font-size: 0.85rem; text-align: center; }
        .btn-remove-row { padding: 0 5px; color: #dc3545; cursor: pointer; }
        .col-header { 
            font-weight: bold; background-color: #e9ecef; 
            padding: 5px; text-align: center; border-radius: 4px; margin-bottom: 8px; 
        }
        
        /* Inputs Desabilitados (Estilo Leitura) */
        input:disabled, button:disabled, select:disabled { 
            cursor: not-allowed; opacity: 1; background-color: #fff !important; 
            color: #212529; border: none; font-weight: bold; 
        }
        .table-lancamento input:disabled { background-color: transparent !important; }
        
        /* Tabela de Lançamento (Play) */
        .table-lancamento th { 
            font-size: 0.75rem; text-transform: uppercase; 
            background-color: #f8f9fa; vertical-align: middle; text-align: center; 
        }
        .table-lancamento td { vertical-align: middle; padding: 4px; }
        
        .inp-game { 
            width: 60px; text-align: center; border: 1px solid #dee2e6; 
            border-radius: 4px; padding: 2px; font-size: 0.9rem; 
        }
        .inp-money { 
            width: 80px; text-align: right; background-color: #f8f9fa; 
            border: none; font-weight: bold; font-size: 0.9rem; color: #495057; padding-right: 5px;
        }
        .inp-edit-money { 
            width: 85px; text-align: right; border: 1px solid #dee2e6; 
            border-radius: 4px; padding: 2px 5px; font-size: 0.9rem; 
        }
        .inp-calc { 
            width: 75px; text-align: right; background-color: #e9ecef; 
            border: none; font-size: 0.85rem; color: #6c757d; font-weight: bold; padding-right: 5px; 
        }
        
        .col-posicao { background-color: #fff3cd !important; }
        .col-taxa { background-color: #fff3cd !important; border-left: 2px solid #dee2e6; }
        
        /* Leaderboard (Classificação) */
        .rank-1 { background-color: #fff3cd !important; font-weight: bold; }
        .rank-2 { background-color: #e2e3e5 !important; font-weight: bold; }
        .rank-3 { background-color: #f3e2d9 !important; font-weight: bold; }
        .td-pontos { 
            font-weight: bold; text-align: center; 
            background-color: #f8f9fa; border-left: 1px solid #dee2e6; border-right: 1px solid #dee2e6; 
        }
        .th-rodada { 
            min-width: 40px; text-align: center; 
            background-color: #343a40 !important; color: white; font-size: 0.8rem; 
        }

        /* Relatório Financeiro */
        .td-money { text-align: right; white-space: nowrap; }
        .text-red { color: #dc3545; font-weight: bold; }
        .text-green { color: #198754; font-weight: bold; }
        .bg-total { background-color: #212529 !important; color: #fff; font-weight: bold; }

        /* MODO IMPRESSÃO */
        @media print {
            .no-print, nav, .modal-footer, .btn, .form-switch, .input-group { display: none !important; }
            .card { border: none !important; box-shadow: none !important; }
            .card-header { background-color: #fff !important; border-bottom: 2px solid #000 !important; }
            body { background-color: #fff; }
            .table { width: 100%; border-collapse: collapse; }
            .table th, .table td { border: 1px solid #ddd !important; }
            /* Remove bordas de inputs na impressão para parecer texto */
            input { border: none !important; background: transparent !important; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow no-print">
  <div class="container">
    <span class="navbar-brand fw-bold"><i class="bi bi-suit-spade-fill text-danger"></i> CPCA Manager</span>
    <div class="d-flex align-items-center">
        <span id="navUserInfo" class="text-light me-3 small fw-bold"></span>
        <button id="btnLogout" class="btn btn-outline-danger btn-sm hidden">Sair</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
    <div id="authContainer">
        <div class="row justify-content-center pt-5">
            <div class="col-md-5">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5">
                        <h3 class="text-center mb-4 fw-bold">Acesso ao Clube</h3>
                        <form id="formLogin">
                            <div class="mb-3">
                                <input type="email" class="form-control form-control-lg" id="loginEmail" placeholder="Email" required>
                            </div>
                            <div class="mb-4">
                                <input type="password" class="form-control form-control-lg" id="loginSenha" placeholder="Senha" required>
                            </div>
                            <button type="submit" class="btn btn-dark w-100 btn-lg fw-bold">Entrar</button>
                        </form>
                        <div id="loginMsg" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="appDashboard" class="hidden">
        <ul class="nav nav-pills mb-4 gap-2 no-print" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active fw-bold" id="pills-jogadores-tab" data-bs-toggle="pill" data-bs-target="#pills-jogadores">
                    <i class="bi bi-people-fill"></i> Jogadores
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold" id="pills-rankings-tab" data-bs-toggle="pill" data-bs-target="#pills-rankings">
                    <i class="bi bi-trophy-fill"></i> Rankings & Temporadas
                </button>
            </li>
        </ul>

        <div id="lembreteAniversariantes" class="card shadow-sm mb-4 bg-light border-primary" style="display: none;">
            <div class="card-body p-3">
               <div class="d-flex justify-content-between align-items-center">
                   <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-cake2-fill"></i> Aniversariantes de <span id="aniversarioMes"></span></h5>
                   <button type="button" class="btn-close" onclick="document.getElementById('lembreteAniversariantes').style.display='none'"></button>
               </div>
               <hr class="my-2">
               <div id="listaAniversariantes" class="d-flex flex-wrap gap-3">
                   <!-- Birthday players will be injected here -->
               </div>
           </div>
       </div>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="pills-jogadores">
                
                <div class="row mb-3 align-items-end no-print">
                    <div class="col-md-8">
                        <h4 class="fw-bold mb-3">Base de Jogadores</h4>
                        <div class="d-flex gap-2">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                                <input type="search" class="form-control border-start-0" id="buscaJogador" placeholder="Buscar por Apelido, Nome ou Email..." onkeyup="filtrarJogadoresUI()">
                            </div>
                            <div class="input-group" style="width: 220px;">
                                <label class="input-group-text" for="selOrdenacaoJogadores"><i class="bi bi-sort-alpha-down"></i></label>
                                <select class="form-select" id="selOrdenacaoJogadores">
                                    <option value="apelido" selected>Ordenar por Apelido</option>
                                    <option value="nome">Ordenar por Nome</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group shadow-sm">
                            <button class="btn btn-outline-secondary" onclick="window.print()">
                                <i class="bi bi-printer"></i> Imprimir
                            </button>
                            <button class="btn btn-outline-success" onclick="exportarJogadoresCSV()">
                                <i class="bi bi-file-earmark-excel"></i> Exportar CSV
                            </button>
                            <button class="btn btn-primary fw-bold" id="btnNovoJogador" onclick="abrirModal(null, false)">
                                + Novo Jogador
                            </button>
                        </div>
                        <div class="form-check form-switch mt-2 d-inline-block ms-3">
                            <input class="form-check-input" type="checkbox" id="checkMostrarArquivados">
                            <label class="form-check-label small text-muted" for="checkMostrarArquivados">Mostrar Arquivados</label>
                        </div>
                    </div>
                </div>

                <div class="card shadow border-0">
                    <div class="card-header p-1 no-print" id="headerCor" style="background-color: #0d6efd;"></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tabelaJogadoresPrint">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">Apelido</th>
                                        <th>Nome Completo</th>
                                        <th>Data Nasc.</th>
                                        <th>Celular</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th class="text-end pe-4 no-print">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaJogadores">
                                    <tr><td colspan="7" class="text-center p-4">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted small no-print" id="footerTotal">...</div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-rankings">
                <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                    <h4 class="fw-bold mb-0">Temporadas do CPCA</h4>
                    <button class="btn btn-primary fw-bold hidden" id="btnNovoRanking" onclick="abrirModalRanking(null)">Nova Temporada</button>
                </div>
                <div id="listaRankings" class="row g-4">
                    <div class="col-12 text-center text-muted py-5">Carregando rankings...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalJogador" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold" id="modalTitle">Novo Jogador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formJogador" class="row g-3">
                    <input type="hidden" id="editUid">
                    <h6 class="text-primary border-bottom pb-2">Identidade (Obrigatório)</h6>
                    <div class="col-md-4"><label class="form-label small fw-bold">Apelido (Nick) *</label><input type="text" class="form-control" id="cadApelido" required></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">Nome *</label><input type="text" class="form-control" id="cadNome" required></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">Sobrenome *</label><input type="text" class="form-control" id="cadSobrenome" required></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">CPF *</label><input type="text" class="form-control" id="cadCpf" maxlength="14" required></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">Data Nascimento *</label><input type="date" class="form-control" id="cadNascimento" required></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">Celular *</label><input type="tel" class="form-control" id="cadCelular" required></div>
                    <div class="col-md-12"><label class="form-label small fw-bold">Email *</label><input type="email" class="form-control" id="cadEmail" required></div>
                    <h6 class="text-primary border-bottom pb-2 mt-4">Dados do Clube (Restrito)</h6>
                    <div class="col-md-4"><label class="form-label small fw-bold">Home Game</label><input type="text" class="form-control" value="CPCA" disabled></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">ID Membro</label><input type="text" class="form-control bg-light" id="cadIdMembro"></div>
                    <div class="col-md-4"><label class="form-label small fw-bold">Nick Club GG</label><input type="text" class="form-control bg-light" id="cadNickGG"></div>
                    <div class="col-md-12"><label class="form-label small fw-bold">Função</label><select id="cadRole" class="form-select"><option value="player">Jogador</option><option value="manager">Manager</option><option value="admin">ADMIN</option></select></div>
                    <div class="col-md-12" id="divSenha"><label class="form-label small fw-bold">Senha Inicial *</label><input type="password" class="form-control" id="cadSenha" minlength="6"></div>
                    <div class="col-12 mt-4 text-end">
                        <div id="modalMsg" class="mb-2 text-danger fw-bold"></div>
                        <button type="submit" class="btn btn-success fw-bold px-4" id="btnSalvarModal">Salvar Dados</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRelatorioFinanceiro" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-cash-stack"></i> Relatório Financeiro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold">Filtrar:</label>
                        <select class="form-select" id="selFiltroRodadaFinanceiro" onchange="filtrarRelatorioFinanceiro()">
                            <option value="todos">Geral</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end align-self-end">
                        <button class="btn btn-outline-dark" onclick="filtrarRelatorioFinanceiro()">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="card bg-white mb-3 shadow-sm">
                    <div class="card-body p-2 text-center">
                        <small class="text-muted">Valor Total Retido de Torneios na Temporada:</small>
                        <span class="fw-bold ms-2 text-primary" id="relatorioTotalRetido">R$ 0,00</span>
                    </div>
                </div>
                <div class="card shadow border-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered mb-0" style="font-size:0.9rem">
                            <thead class="table-light">
                                <tr class="text-center">
                                    <th style="width:20%">Jogador</th>
                                    <th style="width:13%">Invest. (R$)</th>
                                    <th style="width:13%">Fichas (Mesa)</th>
                                    <th style="width:13%">Sobras (Rank)</th>
                                    <th style="width:13%">Cash Out / Prêmio</th>
                                    <th style="width:13%">Taxa Rank</th>
                                    <th style="width:15%">Balanço</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyRelatorioFinanceiro">
                                <tr><td colspan="7" class="text-center p-5">Carregando...</td></tr>
                            </tbody>
                            <tfoot class="bg-total">
                                <tr id="tfootRelatorioFinanceiro" class="text-end"></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalClassificacao" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title fw-bold" id="tituloClassificacao">Classificação Geral</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-white p-0">
            <div class="row g-0 h-100">
                <div class="col-md-9 h-100 overflow-auto border-end">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped mb-0 text-center" style="font-size:0.9rem;white-space:nowrap">
                            <thead class="sticky-top bg-white">
                                <tr id="headerClassificacao"></tr>
                            </thead>
                            <tbody id="bodyClassificacao"></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-3 h-100 bg-light p-3 overflow-auto">
                    <h5 class="fw-bold text-success border-bottom pb-2 mb-3">Premiação Acumulada</h5>
                    <div class="card mb-3 border-success shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Total Arrecadado:</span>
                                <h4 class="fw-bold text-success mb-0" id="financeiroTotal">R$ 0,00</h4>
                            </div>
                            <hr class="my-2">
                            <ul class="list-unstyled small text-muted mb-0" id="financeiroDetalhes">
                                <!-- Details will be injected here -->
                            </ul>
                        </div>
                    </div>
                    <h6 class="fw-bold text-dark mt-4 mb-2">Projeção de Pagamento</h6>
                    <ul class="list-group" id="listaPremiacaoProjetada"></ul>
                </div>
            </div>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="modalGestaoRodadas" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <div><h5 class="modal-title fw-bold">Gerenciar Rodadas</h5><small class="text-white-50" id="subtituloRanking">...</small></div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-dark fw-bold mb-0">Calendário</h6>
                <button class="btn btn-success btn-sm fw-bold hidden" id="btnNovaRodadaModal" onclick="abrirModalEdicaoRodada(null)">
                    Adicionar Rodada
                </button>
            </div>
            <div class="card shadow-sm border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center table-sm">
                        <thead class="table-secondary">
                            <tr>
                                <th>#</th>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th class="border-start">Buy-In</th>
                                <th>Fichas</th>
                                <th class="border-start">Rebuy</th>
                                <th>Fichas</th>
                                <th class="border-start">Add-On</th>
                                <th>Fichas</th>
                                <th class="border-start">Bônus</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaRodadas"></tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="modalLancamento" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <div class="d-flex align-items-center">
              <h5 class="modal-title fw-bold text-dark me-3" id="tituloLancamento">Lançamento</h5>
              <span class="badge bg-dark me-2" id="lblTipoJogo">...</span>
              <span class="badge bg-light text-dark border me-3">BuyIn: R$ <span id="lblValorBuyIn">0</span></span>
              <div class="vr me-3"></div>
              <div class="d-flex align-items-center small text-dark">
                  <span class="fw-bold me-2">Resumo:</span>
                  <span class="badge bg-success me-1">Entradas: <span id="lblTotalEntradas">R$ 0</span></span>
                  <span class="badge bg-danger me-1">Saídas: <span id="lblTotalSaidas">R$ 0</span></span>
                  <span class="badge bg-light text-dark border">Retido: <span id="lblTotalRetido">R$ 0</span></span>
              </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light">
            <div class="row mb-3 align-items-end" id="divControlesLancamento">
                <div class="col-md-4">
                    <label class="small fw-bold">Adicionar Jogador</label>
                    <div class="input-group">
                        <select class="form-select" id="selectJogadorLancamento"><option value="">Selecione...</option></select>
                        <button class="btn btn-primary" onclick="adicionarJogadorNaMesa()"><i class="bi bi-plus-lg"></i></button>
                    </div>
                </div>
                <div class="col-md-8 text-end">
                    <small class="text-muted fst-italic me-2" id="msgRegraCash">Regra Cash: Saída arredondada (múltiplo de 10). O resto vai para Sobras.</small>
                </div>
            </div>
            <div id="alertReadOnly" class="alert alert-info d-none text-center p-2 mb-2">
                <i class="bi bi-eye"></i> <b>Modo de Visualização:</b> Você não tem permissão para alterar os resultados.
            </div>
            <div class="card shadow border-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 table-lancamento">
                        <thead id="headerTabelaLancamento"></thead>
                        <tbody id="tbodyLancamento"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer bg-white">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-success fw-bold px-4" id="btnSalvarLancamento" onclick="salvarLançamentoGeral()">
                <i class="bi bi-save"></i> Salvar Resultados
            </button>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="modalNovaRodada" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold" id="tituloModalRodada">Cadastrar Rodada</h5>
                <button type="button" class="btn-close btn-close-white" onclick="fecharModalNovaRodada()"></button>
            </div>
            <div class="modal-body">
                <form id="formRodada">
                    <input type="hidden" id="rodadaEditId">
                    <div class="row mb-3">
                        <div class="col-md-3"><label class="form-label small fw-bold">Número #</label><input type="number" class="form-control" id="rodNumero" required></div>
                        <div class="col-md-5"><label class="form-label small fw-bold">Data</label><input type="date" class="form-control" id="rodData" required></div>
                        <div class="col-md-4"><label class="form-label small fw-bold">Tipo</label><select class="form-select" id="rodTipo" onchange="aplicarPreSets()"><option value="Cash">Cash Game</option><option value="Torneio">Torneio</option></select></div>
                    </div>
                    <hr>
                    <h6 class="text-success fw-bold mb-3">Estrutura</h6>
                    <div class="row g-3">
                        <div class="col-md-4"><div class="card bg-light border-0 h-100"><div class="card-body p-2"><div class="small fw-bold text-center mb-2">BUY-IN</div><div class="input-group input-group-sm mb-2"><span class="input-group-text">R$</span><input type="number" class="form-control" id="rodBuyInValor" placeholder="0,00"></div><div class="input-group input-group-sm"><span class="input-group-text"><i class="bi bi-circle-fill"></i></span><input type="number" class="form-control" id="rodBuyInFichas" placeholder="Fichas"></div></div></div></div>
                        <div class="col-md-4"><div class="card bg-light border-0 h-100"><div class="card-body p-2"><div class="small fw-bold text-center mb-2">REBUY</div><div class="input-group input-group-sm mb-2"><span class="input-group-text">R$</span><input type="number" class="form-control" id="rodRebuyValor" placeholder="0,00"></div><div class="input-group input-group-sm"><span class="input-group-text"><i class="bi bi-circle-fill"></i></span><input type="number" class="form-control" id="rodRebuyFichas" placeholder="Fichas"></div></div></div></div>
                        <div class="col-md-4"><div class="card bg-light border-0 h-100"><div class="card-body p-2"><div class="small fw-bold text-center mb-2">ADD-ON / BÔNUS</div><div class="input-group input-group-sm mb-2"><span class="input-group-text">R$</span><input type="number" class="form-control" id="rodAddOnValor" placeholder="0,00"></div><div class="input-group input-group-sm mb-2"><span class="input-group-text"><i class="bi bi-circle-fill"></i></span><input type="number" class="form-control" id="rodAddOnFichas" placeholder="Fichas"></div><div class="input-group input-group-sm"><span class="input-group-text text-warning"><i class="bi bi-star-fill"></i></span><input type="number" class="form-control" id="rodBonusFichas" placeholder="Bônus"></div></div></div></div>
                    </div>
                    <div class="text-end mt-4"><button type="submit" class="btn btn-success fw-bold px-4" id="btnSalvarRodada">Salvar Rodada</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRanking" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="modalRankingTitle">Configurar Temporada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formRanking">
                    <input type="hidden" id="rankingEditId">
                    <div class="row mb-3">
                        <div class="col-md-8"><label class="form-label fw-bold">Nome da Temporada</label><input type="text" class="form-control" id="rankNome" required></div>
                        <div class="col-md-4"><label class="form-label fw-bold">Status</label><select class="form-select" id="rankStatus"><option value="Rascunho">Rascunho</option><option value="Ativo">Ativo</option><option value="Finalizado">Finalizado</option></select></div>
                    </div>
                    <div id="alertRankingLocked" class="alert alert-warning small d-none"><i class="bi bi-lock-fill"></i> <b>Bloqueado:</b> Ranking Ativo/Finalizado. Regras de pontuação não podem ser alteradas.</div>
                    <ul class="nav nav-tabs mb-3" id="rankTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="tab-conf" data-bs-toggle="tab" data-bs-target="#content-conf" type="button">Pontuação (Fórmula)</button></li>
                        <li class="nav-item"><button class="nav-link" id="tab-premio" data-bs-toggle="tab" data-bs-target="#content-premio" type="button">Prêmios (%)</button></li>
                        <li class="nav-item"><button class="nav-link text-success" id="tab-sim" data-bs-toggle="tab" data-bs-target="#content-sim" type="button">Simular</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="content-conf">
                            <div class="row">
                                <div class="col-md-4 border-end"><div class="col-header text-primary">Colocação (c)</div><div id="container-c"></div><button type="button" class="btn btn-sm btn-outline-primary w-100 mt-2 btn-add-row" onclick="addLinhaC()">+ Adicionar</button><div class="mt-3 p-2 bg-light rounded border"><label class="small fw-bold">Base:</label><input type="number" class="form-control form-control-sm" id="rankBase" value="1"></div></div>
                                <div class="col-md-4 border-end"><div class="col-header text-success">Fator Jogadores (fj)</div><div class="row g-1 mb-1 small fw-bold text-center"><div class="col-5">Qtd</div><div class="col-5">Fator</div></div><div id="container-fj"></div><button type="button" class="btn btn-sm btn-outline-success w-100 mt-2 btn-add-row" onclick="addLinhaFj()">+ Adicionar</button></div>
                                <div class="col-md-4"><div class="col-header text-danger">Fator Buy-In (fb)</div><div class="row g-1 mb-1 small fw-bold text-center"><div class="col-5">Valor ($)</div><div class="col-5">Fator</div></div><div id="container-fb"></div><button type="button" class="btn btn-sm btn-outline-danger w-100 mt-2 btn-add-row" onclick="addLinhaFb()">+ Adicionar</button></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="content-premio">
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <div class="alert alert-info small">Defina a % do pote total para cada posição final no ranking.</div>
                                    <div class="col-header text-dark">Distribuição (%)</div>
                                    <div class="row g-1 mb-1 small fw-bold text-center"><div class="col-5">Posição</div><div class="col-5">% Pote</div></div>
                                    <div id="container-p"></div>
                                    <button type="button" class="btn btn-sm btn-outline-dark w-100 mt-2 btn-add-row" onclick="addLinhaP()">+ Adicionar Posição</button>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="content-sim">
                            <div class="bg-light p-4 rounded text-center">
                                <h5 class="fw-bold mb-4">Simulador</h5>
                                <div class="row justify-content-center g-3">
                                    <div class="col-md-3"><label class="small fw-bold">Colocação</label><input type="number" class="form-control text-center" id="simPos" value="1"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Qtd. Jogadores</label><input type="number" class="form-control text-center" id="simQtd" value="10"></div>
                                    <div class="col-md-3"><label class="small fw-bold">Valor Buy-In</label><input type="number" class="form-control text-center" id="simBuyIn" value="20"></div>
                                </div>
                                <div class="my-4"><div class="small text-muted mb-1">Resultado (c * fj * fb):</div><h1 class="display-3 fw-bold text-primary" id="simResultado">0.00</h1></div>
                                <button type="button" class="btn btn-lg btn-secondary" onclick="simularPontos()">Calcular</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer px-0 pb-0 mt-3 border-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary fw-bold px-4" id="btnSalvarRanking">Salvar</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, orderBy, onSnapshot, where, getDocs, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // CONFIGURAÇÃO FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAeV9yLxe-ekxuHSAgNTZu1Xtd943bnNig",
    authDomain: "hgpokermanagerapp.firebaseapp.com",
    projectId: "hgpokermanagerapp",
    storageBucket: "hgpokermanagerapp.firebasestorage.app",
    messagingSenderId: "595793069104",
    appId: "1:595793069104:web:933acb6434696529cb59f5"
  };

  // Inicialização
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
  const secondaryAuth = getAuth(secondaryApp);

  // Globais
  let currentUser = null;
  let currentRankingId = null;
  let currentRodadaId = null;
  let currentRodadaData = null;
  let currentRankingData = null;
  let playersList = [];
  let globalJogadoresData = []; // Cache de jogadores
  let financeiroCacheData = []; // Cache de financeiro
  
  let mostrarArquivados = false;
  let unsubscribePlayers = null;
  let unsubscribeRankings = null;
  let unsubscribeRodadas = null;
  let nextRodadaNumero = 1;
  let editingId = null; 
  let isLancamentoReadOnly = false; // Controle de permissão do Play

  // Instâncias Modais
  const modalGestaoRodadas = new bootstrap.Modal(document.getElementById('modalGestaoRodadas'));
  const modalNovaRodada = new bootstrap.Modal(document.getElementById('modalNovaRodada'));
  const modalLancamento = new bootstrap.Modal(document.getElementById('modalLancamento'));
  const modalJogador = new bootstrap.Modal(document.getElementById('modalJogador'));
  const modalRanking = new bootstrap.Modal(document.getElementById('modalRanking'));
  const modalClassificacao = new bootstrap.Modal(document.getElementById('modalClassificacao'));
  const modalRelatorioFinanceiro = new bootstrap.Modal(document.getElementById('modalRelatorioFinanceiro'));

  // ========================================================
  // MODULO 1: ENGINE DE LANÇAMENTO E CÁLCULO (CORE)
  // ========================================================

  // --- FUNÇÕES DE LÓGICA E CÁLCULO ---

  function calcularPontos(posicao, qtdJogadores, buyIn) {
      let pontos = 0;
      if (posicao > 0 && currentRankingData) {
          const rules = currentRankingData.sistemaPontuacao;
          let c = rules.base_c;
          const foundC = rules.tabela_c.find(x => x.pos === posicao);
          if (foundC) c = foundC.pts;
          
          let fj = 1.0;
          const foundFj = rules.tabela_fj.find(x => x.qtd === qtdJogadores);
          if (foundFj) fj = foundFj.fator;
          
          let fb = 1.0;
          const foundFb = rules.tabela_fb.find(x => x.buyin === buyIn);
          if (foundFb) fb = foundFb.fator;

          pontos = c * fj * fb;
      }
      return pontos;
  }

  function recalcularLinha(uid) {
      const tr = document.getElementById(`tr-${uid}`);
      if (!tr) return;

      const buyins = parseInt(tr.querySelector('.inp-buyin').value) || 0;
      const rebuys = parseInt(tr.querySelector('.inp-rebuy').value) || 0;
      const addons = parseInt(tr.querySelector('.inp-addon').value) || 0;
      const saidaRaw = parseFloat(tr.querySelector('.inp-saida').value) || 0;

      const totalInvestido = (buyins * currentRodadaData.buyInValor) + (rebuys * currentRodadaData.rebuyValor) + (addons * currentRodadaData.addOnValor);
      tr.querySelector('.inp-total-inv').value = totalInvestido.toFixed(2);

      if (currentRodadaData.tipo === 'Cash') {
          const saldoFichas = saidaRaw - totalInvestido;
          tr.querySelector('.inp-saldo-fichas').value = saldoFichas.toFixed(2);
          
          const pagavel = Math.floor(saidaRaw / 10) * 10;
          const sobras = saidaRaw - pagavel;
          tr.querySelector('.inp-sobras').value = sobras.toFixed(2);
          tr.querySelector('.inp-cashout').value = pagavel.toFixed(2);
      }
  }

function autoPosicionarPorSaldo() {
    if (currentRodadaData.tipo !== 'Cash') return;
    const tbody = document.getElementById('tbodyLancamento');
    const linhas = tbody.querySelectorAll('tr');
    
    if (linhas.length === 0) {
        recalcularTotaisGerais();
        return;
    }
    
    let saldos = [];
    linhas.forEach(tr => {
        recalcularLinha(tr.dataset.uid); // Ensure saldo is up-to-date
        saldos.push({
            uid: tr.dataset.uid,
            saldo: parseFloat(tr.querySelector('.inp-saldo-fichas').value) || -Infinity
        });
    });

    saldos.sort((a, b) => b.saldo - a.saldo);

    const qtdJogadores = linhas.length;
    saldos.forEach((item, index) => {
        const pos = index + 1;
        const tr = document.getElementById(`tr-${item.uid}`);
        if(tr) {
            tr.querySelector('.inp-posicao').value = pos;
            const pontos = calcularPontos(pos, qtdJogadores, currentRodadaData.buyInValor);
            tr.querySelector('.lbl-pontos').innerText = pontos.toFixed(2);
            tbody.appendChild(tr); // Re-append the node to sort it in the DOM
        }
    });

    recalcularTotaisGerais();
}

  window.handleSaldoChange = (uid) => {
      autoPosicionarPorSaldo();
  };

  window.handleGenericChange = (uid) => {
      const tr = document.getElementById(`tr-${uid}`);
      if (!tr) return;

      recalcularLinha(uid); 

      const posicao = parseInt(tr.querySelector('.inp-posicao').value) || 0;
      const qtdJogadores = document.querySelectorAll('#tbodyLancamento tr').length;
      const pontos = calcularPontos(posicao, qtdJogadores, currentRodadaData.buyInValor);
      tr.querySelector('.lbl-pontos').innerText = pontos.toFixed(2);
      
      recalcularTotaisGerais();
  };

  // --- FUNÇÕES DE UI E DADOS ---

  // A. Abrir Tela
  window.abrirLancamento = async (rodadaId, readOnly = false) => {
      currentRodadaId = rodadaId;
      isLancamentoReadOnly = readOnly;
      
      // Busca dados
      const rSnap = await getDoc(doc(db, "rankings", currentRankingId, "rodadas", rodadaId));
      currentRodadaData = rSnap.data();
      const rankSnap = await getDoc(doc(db, "rankings", currentRankingId));
      currentRankingData = rankSnap.data();

      // Configura Header
      let tituloAction = readOnly ? "Visualizar" : "Lançamento";
      document.getElementById('tituloLancamento').innerText = `${tituloAction} Rodada #${currentRodadaData.numero} - ${currentRodadaData.tipo}`;
      document.getElementById('lblTipoJogo').innerText = currentRodadaData.tipo.toUpperCase();
      document.getElementById('lblValorBuyIn').innerText = currentRodadaData.buyInValor.toFixed(2);
      
      const isCash = currentRodadaData.tipo === 'Cash';
      document.getElementById('msgRegraCash').style.display = isCash ? 'inline' : 'none';

      // Controle de Acesso Visual
      document.getElementById('divControlesLancamento').classList.toggle('d-none', readOnly);
      document.getElementById('btnSalvarLancamento').classList.toggle('d-none', readOnly);
      document.getElementById('alertReadOnly').classList.toggle('d-none', !readOnly);

      // Header da Tabela Dinâmica
      const headerTr = document.getElementById('headerTabelaLancamento');
      if (isCash) {
          headerTr.innerHTML = `
            <th style="width:15%">Jogador</th>
            <th style="width:5%">Buy</th><th style="width:5%">Reb</th><th style="width:5%">Add</th><th style="width:5%">Bon</th>
            <th style="width:8%" class="bg-light border-start">Invest. (R$)</th>
            <th style="width:8%">Fichas (Mesa)</th>
            <th style="width:8%" class="bg-light">Saldo Fichas</th>
            <th style="width:8%">Sobras (Rank)</th>
            <th style="width:8%" class="bg-light text-muted">Cash Out</th>
            <th style="width:8%" class="col-posicao border-start">Posição</th>
            <th style="width:6%">Pontos</th>
            <th style="width:8%" class="col-taxa">Taxa Rank</th>
            <th style="width:5%">Del</th>`;
      } else {
          headerTr.innerHTML = `
            <th style="width:15%">Jogador</th>
            <th style="width:5%">Buy</th><th style="width:5%">Reb</th><th style="width:5%">Add</th><th style="width:5%">Bon</th>
            <th style="width:8%" class="bg-light border-start">Invest. (R$)</th>
            <th style="width:8%" class="col-posicao border-start">Posição</th>
            <th style="width:8%">Premiação R$</th>
            <th style="width:8%">---</th>
            <th style="width:6%">Pontos</th>
            <th style="width:8%" class="col-taxa">Taxa Rank</th>
            <th style="width:5%">Del</th>`;
      }

      // Dropdown Jogadores (do Cache Global)
      const select = document.getElementById('selectJogadorLancamento');
      select.innerHTML = '<option value="">Selecione um jogador...</option>';
      globalJogadoresData.forEach(p => {
          if(p.ativo !== false) {
              select.innerHTML += `<option value="${p.id}">${p.apelido} (${p.nome})</option>`;
          }
      });

      // Carregar e Calcular
      carregarResultadosTabela();
      modalLancamento.show();
  };

  // B. Carregar Resultados do Banco
  async function carregarResultadosTabela() {
      const isCash = currentRodadaData.tipo === 'Cash';
      const q = isCash
        ? query(collection(db, "rankings", currentRankingId, "rodadas", currentRodadaId, "jogadores"))
        : query(collection(db, "rankings", currentRankingId, "rodadas", currentRodadaId, "jogadores"), orderBy("posicao", "asc"));
      
      const snap = await getDocs(q);
      document.getElementById('tbodyLancamento').innerHTML = '';
      
      snap.forEach(doc => {
          renderizarLinhaJogador(doc.id, doc.data());
      });
      
      if (currentRodadaData.tipo === 'Cash') {
          autoPosicionarPorSaldo();
      } else {
          recalcularTotaisGerais();
      }
  }

  // C. Adicionar Jogador na Mesa
  window.adicionarJogadorNaMesa = () => {
      const select = document.getElementById('selectJogadorLancamento');
      const uid = select.value;
      if(!uid) return;
      
      if(document.getElementById(`tr-${uid}`)) {
          alert("Jogador já adicionado na mesa!"); return;
      }

      const player = globalJogadoresData.find(p => p.id === uid);
      
      // Dados padrão
      const data = {
          apelido: player.apelido,
          buyins: 1, rebuys: 0, addons: 0, bonus: 0, taxa: 0,
          investimento: 0, saida: 0, sobras: 0, cashout: 0, posicao: 0, pontos: 0
      };
      
      renderizarLinhaJogador(uid, data);
      
      if (currentRodadaData.tipo === 'Cash') {
          autoPosicionarPorSaldo();
      } else {
          handleGenericChange(uid);
      }
      select.value = "";
  };

  // D. Renderizar Linha (HTML)
  function renderizarLinhaJogador(uid, data) {
      const tbody = document.getElementById('tbodyLancamento');
      const tr = document.createElement('tr');
      tr.id = `tr-${uid}`;
      tr.dataset.uid = uid;
      
      const isCash = currentRodadaData.tipo === 'Cash';
      const taxaVal = data.taxa !== undefined ? data.taxa : 0;
      const sobrasVal = data.sobras !== undefined ? data.sobras : 0;
      const cashOutVal = data.cashout !== undefined ? data.cashout : 0;
      const disableAttr = isLancamentoReadOnly ? 'disabled' : '';

      const saldoChange = `onchange="window.handleSaldoChange('${uid}')"`;
      const genericChange = `onchange="window.handleGenericChange('${uid}')"`;

      // Colunas Comuns
      let innerContent = `
        <td><b>${data.apelido}</b></td>
        <td><input type="number" class="inp-game inp-buyin" value="${data.buyins}" min="1" ${isCash ? saldoChange : genericChange} ${disableAttr}></td>
        <td><input type="number" class="inp-game inp-rebuy" value="${data.rebuys}" min="0" ${isCash ? saldoChange : genericChange} ${disableAttr}></td>
        <td><input type="number" class="inp-game inp-addon" value="${data.addons}" min="0" ${isCash ? saldoChange : genericChange} ${disableAttr}></td>
        <td><input type="number" class="inp-game inp-bonus" value="${data.bonus}" min="0" ${genericChange} ${disableAttr}></td>
        <td class="bg-light border-start"><input type="text" class="inp-money inp-total-inv" readonly value="${(data.investimento||0).toFixed(2)}"></td>`;

      const inputTaxa = `<td class="col-taxa"><input type="number" step="0.5" class="inp-edit-money inp-taxa" value="${taxaVal}" onchange="recalcularLinha('${uid}')" ${disableAttr}></td>`;
      
      let btnDel;
      if (isLancamentoReadOnly) {
          btnDel = '<td></td>';
      } else {
          const action = isCash ? 'autoPosicionarPorSaldo()' : 'recalcularTotaisGerais()';
          btnDel = `<td class="text-center"><button class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('tr').remove(); ${action};"><i class="bi bi-x-lg"></i></button></td>`;
      }
      
      if (isCash) {
          innerContent += `
            <td><input type="number" step="0.01" class="inp-edit-money inp-saida" value="${data.saida}" ${saldoChange} ${disableAttr}></td>
            <td><input type="text" class="inp-calc inp-saldo-fichas text-primary" readonly value="0.00"></td>
            <td><input type="text" class="inp-calc inp-sobras" readonly value="${sobrasVal.toFixed(2)}"></td>
            <td><input type="text" class="inp-calc inp-cashout bg-light text-dark fw-bold" readonly value="${cashOutVal.toFixed(2)}"></td>
            <td class="col-posicao border-start"><input type="number" class="inp-game inp-posicao fw-bold" value="${data.posicao}" min="0" ${genericChange} ${disableAttr}></td>
            <td class="fw-bold text-primary text-center lbl-pontos">${(data.pontos||0).toFixed(2)}</td>
            ${inputTaxa}`;
      } else {
          innerContent += `
            <td class="col-posicao border-start"><input type="number" class="inp-game inp-posicao fw-bold" value="${data.posicao}" min="0" ${genericChange} ${disableAttr}></td>
            <td><input type="number" step="0.01" class="inp-edit-money inp-saida" value="${data.saida}" ${genericChange} ${disableAttr}></td>
            <td class="text-center text-muted">---</td>
            <td class="fw-bold text-primary text-center lbl-pontos">${(data.pontos||0).toFixed(2)}</td>
            ${inputTaxa} <input type="hidden" class="inp-sobras" value="0"><input type="hidden" class="inp-cashout" value="0">`;
      }

      tr.innerHTML = innerContent + btnDel;
      tbody.appendChild(tr);
      
      // Força cálculo visual inicial
      recalcularLinha(uid); 
  }

  // E. Função de Cálculo Individual
  window.recalcularLinha = (uid) => {
      const tr = document.getElementById(`tr-${uid}`);
      
      // Coleta
      const buyins = parseInt(tr.querySelector('.inp-buyin').value)||0;
      const rebuys = parseInt(tr.querySelector('.inp-rebuy').value)||0;
      const addons = parseInt(tr.querySelector('.inp-addon').value)||0;
      const taxa = parseFloat(tr.querySelector('.inp-taxa').value)||0;
      const saidaRaw = parseFloat(tr.querySelector('.inp-saida').value)||0;
      const posicao = parseInt(tr.querySelector('.inp-posicao').value)||0;

      // Investimento
      const totalInvestido = (buyins * currentRodadaData.buyInValor) + (rebuys * currentRodadaData.rebuyValor) + (addons * currentRodadaData.addOnValor);
      tr.querySelector('.inp-total-inv').value = totalInvestido.toFixed(2);

      // Sobras e Cashout (Regra de Negócio)
      if (currentRodadaData.tipo === 'Cash') {
          const saldoFichas = saidaRaw - totalInvestido;
          tr.querySelector('.inp-saldo-fichas').value = saldoFichas.toFixed(2);

          const pagavel = Math.floor(saidaRaw / 10) * 10; // Arredonda pra baixo
          const sobras = saidaRaw - pagavel;
          tr.querySelector('.inp-sobras').value = sobras.toFixed(2);
          tr.querySelector('.inp-cashout').value = pagavel.toFixed(2);
      } else {
          if(tr.querySelector('.inp-sobras')) tr.querySelector('.inp-sobras').value = "0.00";
      }

      // Pontuação
      const qtdJogadores = document.querySelectorAll('#tbodyLancamento tr').length;
      let pontos = 0;
      if (posicao > 0) {
          const rules = currentRankingData.sistemaPontuacao;
          let c = rules.base_c;
          const foundC = rules.tabela_c.find(x => x.pos === posicao);
          if (foundC) c = foundC.pts;
          
          let fj = 1.0;
          const foundFj = rules.tabela_fj.find(x => x.qtd === qtdJogadores);
          if (foundFj) fj = foundFj.fator;
          
          let fb = 1.0;
          const foundFb = rules.tabela_fb.find(x => x.buyin === currentRodadaData.buyInValor);
          if (foundFb) fb = foundFb.fator;

          pontos = c * fj * fb;
      }
      tr.querySelector('.lbl-pontos').innerText = pontos.toFixed(2);
      
      // Trigger Global
      recalcularTotaisGerais();
  };

  // F. Totais do Header
  function recalcularTotaisGerais() {
      let totalEntradas = 0;
      let totalSaidas = 0;
      const linhas = document.querySelectorAll('#tbodyLancamento tr');
      const isCash = currentRodadaData.tipo === 'Cash';

      linhas.forEach(tr => {
          totalEntradas += parseFloat(tr.querySelector('.inp-total-inv').value) || 0;
          
          if (isCash) {
              const cashOut = parseFloat(tr.querySelector('.inp-cashout').value) || 0;
              totalSaidas += cashOut;
          } else {
              const premio = parseFloat(tr.querySelector('.inp-saida').value) || 0;
              totalSaidas += premio;
          }
      });

      const retido = totalEntradas - totalSaidas;

      document.getElementById('lblTotalEntradas').innerText = "R$ " + totalEntradas.toFixed(2);
      document.getElementById('lblTotalSaidas').innerText = "R$ " + totalSaidas.toFixed(2);
      
      const elRetido = document.getElementById('lblTotalRetido');
      elRetido.innerText = "R$ " + retido.toFixed(2);
      
      if(retido < 0) elRetido.className = "fw-bold text-danger";
      else elRetido.className = "fw-bold text-success";
  }

  // G. Salvar
  window.salvarLançamentoGeral = async () => {
      if(!confirm("Salvar resultados desta rodada?")) return;
      
      const batch = writeBatch(db);
      const linhas = document.querySelectorAll('#tbodyLancamento tr');
      
      linhas.forEach(tr => {
          const uid = tr.dataset.uid;
          const docRef = doc(db, "rankings", currentRankingId, "rodadas", currentRodadaId, "jogadores", uid);
          
          const sobrasEl = tr.querySelector('.inp-sobras');
          const cashOutEl = tr.querySelector('.inp-cashout');

          const data = {
              apelido: tr.querySelector('td b').innerText,
              buyins: parseInt(tr.querySelector('.inp-buyin').value),
              rebuys: parseInt(tr.querySelector('.inp-rebuy').value),
              addons: parseInt(tr.querySelector('.inp-addon').value),
              bonus: parseInt(tr.querySelector('.inp-bonus').value),
              investimento: parseFloat(tr.querySelector('.inp-total-inv').value),
              taxa: parseFloat(tr.querySelector('.inp-taxa').value),
              saida: parseFloat(tr.querySelector('.inp-saida').value),
              
              sobras: sobrasEl ? parseFloat(sobrasEl.value) : 0,
              cashout: cashOutEl ? parseFloat(cashOutEl.value) : 0,
              
              posicao: parseInt(tr.querySelector('.inp-posicao').value),
              pontos: parseFloat(tr.querySelector('.lbl-pontos').innerText)
          };
          batch.set(docRef, data);
      });

      try {
          await batch.commit();
          alert("Resultados salvos com sucesso!");
          modalLancamento.hide();
      } catch (e) {
          alert("Erro ao salvar: " + e.message);
      }
  };


  // ========================================================
  // MODULO 2: JOGADORES (CADASTRO E LISTA)
  // ========================================================
  function renderizarTabelaJogadores() {
      const tbody = document.getElementById('tabelaJogadores');
      const termo = document.getElementById('buscaJogador').value.toLowerCase();
      const isGestor = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');
      const isUserAdmin = currentUser && currentUser.role === 'admin';

      let html = '';
      let count = 0;

      globalJogadoresData.forEach(p => {
          const ativo = p.ativo !== false;
          if (!mostrarArquivados && !ativo) return;
          if (mostrarArquivados && ativo) return; 

          const textoBusca = `${p.apelido} ${p.nome} ${p.email}`.toLowerCase();
          if (!textoBusca.includes(termo)) return;

          count++;
          let btnActions = `<button class="btn btn-sm btn-info me-1" onclick="window.abrirModal('${p.id}', true)" title="Visualizar"><i class="bi bi-eye"></i></button>`;
          if (isGestor) btnActions += `<button class="btn btn-sm btn-outline-primary me-1" onclick="window.abrirModal('${p.id}', false)" title="Editar"><i class="bi bi-pencil"></i></button>`;
          if (isUserAdmin) {
              const icon = ativo ? 'bi-trash3' : 'bi-arrow-counterclockwise';
              const color = ativo ? 'btn-outline-danger' : 'btn-success';
              btnActions += `<button class="btn btn-sm ${color} border-0" onclick="window.alternarStatusUsuario('${p.id}', ${!ativo}, '${p.apelido}')"><i class="bi ${icon}"></i></button>`;
          }

          html += `
            <tr class="${!ativo ? 'table-secondary' : ''}">
                <td class="ps-4 fw-bold">${p.apelido}</td>
                <td>${p.nome} ${p.sobrenome}</td>
                <td>${formatarDataBR(p.nascimento)}</td>
                <td>${p.celular || '-'}</td>
                <td>${p.email}</td>
                <td><span class="badge bg-secondary">${p.role}</span></td>
                <td class="text-end pe-4 no-print">${btnActions}</td>
            </tr>`;
      });

      if (count === 0) html = '<tr><td colspan="7" class="text-center p-4">Nenhum jogador encontrado.</td></tr>';
      tbody.innerHTML = html;
      document.getElementById('footerTotal').innerText = `Total listado: ${count}`;
  }

  function checarAniversariantes() {
    const container = document.getElementById('lembreteAniversariantes');
    const listaEl = document.getElementById('listaAniversariantes');
    const mesEl = document.getElementById('aniversarioMes');
    
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const nomesMeses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const nomeMesAtual = nomesMeses[mesAtual];

    const aniversariantes = globalJogadoresData.filter(p => {
        if (!p.nascimento || p.ativo === false) return false;
        const mesNascimento = new Date(p.nascimento + 'T12:00:00').getMonth();
        return mesNascimento === mesAtual;
    });

    if (aniversariantes.length > 0) {
        mesEl.innerText = nomeMesAtual;
        let html = '';
        aniversariantes.sort((a, b) => new Date(a.nascimento).getDate() - new Date(b.nascimento).getDate()); // Ordena por dia

        aniversariantes.forEach(p => {
            const dia = p.nascimento.split('-')[2];
            const inicial = p.apelido ? p.apelido.charAt(0).toUpperCase() : '?';
            html += `
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2" style="width: 30px; height: 30px; font-size: 0.8rem;">${inicial}</div>
                    <div>
                        <div class="fw-bold small">${p.apelido}</div>
                        <div class="small text-muted">Dia ${dia}</div>
                    </div>
                </div>
            `;
        });
        listaEl.innerHTML = html;
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
  }

  window.abrirModal = async (id, readOnly = false) => {
      document.getElementById('editUid').value = id || '';
      document.getElementById('formJogador').reset();
      
      const btnSalvar = document.getElementById('btnSalvarModal');
      const title = document.getElementById('modalTitle');
      
      const allInputs = document.querySelectorAll('#formJogador input, #formJogador select');
      allInputs.forEach(i => i.disabled = false);

      if (readOnly) {
          title.innerText = "Visualizar Jogador";
          btnSalvar.classList.add('d-none');
          allInputs.forEach(i => i.disabled = true);
      } else {
          title.innerText = id ? "Editar Jogador" : "Novo Jogador";
          btnSalvar.classList.remove('d-none');
          
          const isAdmin = currentUser.role === 'admin';
          const isManager = currentUser.role === 'manager';
          ['cadIdMembro', 'cadNickGG', 'cadRole'].forEach(f => document.getElementById(f).disabled = !(isAdmin || isManager));
          
          document.getElementById('divSenha').classList.toggle('d-none', !!id);
          if (id) {
               document.getElementById('cadEmail').disabled = true; 
               document.getElementById('cadCpf').disabled = true; 
               document.getElementById('cadSenha').required = false;
          } else {
               document.getElementById('cadSenha').required = true;
          }
      }

      if (id) {
          const p = globalJogadoresData.find(x => x.id === id);
          if (p) {
              document.getElementById('cadApelido').value = p.apelido;
              document.getElementById('cadNome').value = p.nome;
              document.getElementById('cadSobrenome').value = p.sobrenome;
              document.getElementById('cadCpf').value = p.cpf;
              document.getElementById('cadNascimento').value = p.nascimento;
              document.getElementById('cadCelular').value = p.celular;
              document.getElementById('cadEmail').value = p.email;
              document.getElementById('cadIdMembro').value = p.idMembro || '';
              document.getElementById('cadNickGG').value = p.nickGG || '';
              document.getElementById('cadRole').value = p.role || 'player';
          }
      }
      modalJogador.show();
  };
  
  document.getElementById('formJogador').addEventListener('submit', async (e) => {
      e.preventDefault();
      const d = {
          apelido: document.getElementById('cadApelido').value, nome: document.getElementById('cadNome').value, sobrenome: document.getElementById('cadSobrenome').value,
          cpf: document.getElementById('cadCpf').value, nascimento: document.getElementById('cadNascimento').value, celular: document.getElementById('cadCelular').value,
          email: document.getElementById('cadEmail').value, idMembro: document.getElementById('cadIdMembro').value, nickGG: document.getElementById('cadNickGG').value,
          role: document.getElementById('cadRole').value, homeGame: 'CPCA', ativo: true
      };
      const id = document.getElementById('editUid').value;
      try {
          if (id) {
              await updateDoc(doc(db, "jogadores", id), d);
          } else {
              const c = await createUserWithEmailAndPassword(secondaryAuth, d.email, document.getElementById('cadSenha').value);
              await setDoc(doc(db, "jogadores", c.user.uid), { ...d, criadoPor: auth.currentUser.uid, criadoEm: new Date().toISOString() });
              await signOut(secondaryAuth);
          }
          modalJogador.hide();
      } catch(err) { alert(err.message) }
  });

  window.exportarJogadoresCSV = () => {
      let csv = "Apelido;Nome;Sobrenome;Data Nasc;Celular;Email;Role;Status\n";
      globalJogadoresData.forEach(p => {
          const status = p.ativo !== false ? "Ativo" : "Inativo";
          csv += `${p.apelido};${p.nome};${p.sobrenome};${p.nascimento};${p.celular};${p.email};${p.role};${status}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "jogadores_cpca.csv";
      link.click();
  };

  window.filtrarJogadoresUI = () => renderizarTabelaJogadores();
  
  window.alternarStatusUsuario = async (id, status, nome) => {
      if(confirm(`Confirmar alteração de status para ${nome}?`)) {
          await updateDoc(doc(db, "jogadores", id), { ativo: status });
      }
  };

  const inputCPF = document.getElementById('cadCpf');
  inputCPF.addEventListener('input', (e) => {
      let v = e.target.value.replace(/\D/g, "");
      if (v.length > 11) v = v.slice(0, 11);
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      e.target.value = v;
  });
  
  function formatarDataBR(d) {
      if (!d) return '-';
      const p = d.split('-');
      return p.length === 3 ? `${p[2]}/${p[1]}/${p[0]}` : d;
  }

  // ========================================================
  // MODULO 3: GESTÃO DE RANKINGS E RODADAS
  // ========================================================
  
  // Lista Rankings
  function iniciarListaRankings(snapshot) {
      let html = '';
      const isGestor = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');
      
      snapshot.forEach(doc => {
          const r = doc.data();
          let st = r.status || (r.ativo ? 'Ativo' : 'Finalizado');
          const bg = {'Rascunho':'bg-secondary','Ativo':'bg-success','Finalizado':'bg-dark'};
          const isDraft = st === 'Rascunho';
          
          let btnsGestor = '';
          if(isGestor) {
              btnsGestor = `
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="window.copiarRanking('${doc.id}')" title="Duplicar"><i class="bi bi-files"></i></button>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="window.abrirModalRanking('${doc.id}')" title="Configurar"><i class="bi ${isDraft?'bi-pencil':'bi-eye'}"></i></button>
                ${isDraft ? `<button class="btn btn-sm btn-outline-danger me-1" onclick="window.excluirRanking('${doc.id}')"><i class="bi bi-trash"></i></button>` : ''}
              `;
          }

          html += `
          <div class="col-md-6">
              <div class="card h-100 shadow-sm border-0">
                  <div class="card-body">
                      <div class="d-flex justify-content-between mb-2">
                          <h5 class="fw-bold text-primary mb-0">${r.nome}</h5>
                          <div>
                              ${btnsGestor}
                              <span class="badge ${bg[st]}">${st.toUpperCase()}</span>
                          </div>
                      </div>
                      <div class="d-grid gap-2">
                          <button class="btn btn-warning fw-bold" onclick="window.verClassificacao('${doc.id}', '${r.nome}')"><i class="bi bi-trophy-fill"></i> Ver Classificação</button>
                          <button class="btn btn-success fw-bold" onclick="window.abrirRelatorioFinanceiro('${doc.id}')"><i class="bi bi-cash-stack"></i> Relatório Financeiro</button>
                          <button class="btn btn-outline-success fw-bold" onclick="window.abrirGestaoRodadas('${doc.id}','${r.nome}')"><i class="bi bi-calendar-week"></i> ${isGestor ? 'Gerenciar' : 'Ver'} Rodadas</button>
                      </div>
                  </div>
              </div>
          </div>`;
      });
      document.getElementById('listaRankings').innerHTML = html;
  }

  // Gestão Rodadas
  window.abrirGestaoRodadas = async (rankingId, nomeRanking) => {
      currentRankingId = rankingId;
      document.getElementById('subtituloRanking').innerText = nomeRanking;
      document.getElementById('tabelaRodadas').innerHTML = '<tr><td colspan="11" class="p-4">Carregando...</td></tr>';
      
      const isGestor = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');
      document.getElementById('btnNovaRodadaModal').classList.toggle('hidden', !isGestor);

      modalGestaoRodadas.show();
      listarRodadas(rankingId);
  };

  function listarRodadas(rankingId) {
      if(unsubscribeRodadas) unsubscribeRodadas();
      const q = query(collection(db, "rankings", rankingId, "rodadas"), orderBy("numero", "asc"));
      
      unsubscribeRodadas = onSnapshot(q, (snapshot) => {
          let html = '';
          nextRodadaNumero = 1;
          const isGestor = currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager');

          snapshot.forEach((doc) => {
              const r = doc.data();
              nextRodadaNumero = Math.max(nextRodadaNumero, parseInt(r.numero) + 1);
              const badge = r.tipo === 'Torneio' ? 'badge-torneio' : 'badge-cash';
              
              const btnsGestor = isGestor ? `
                <button class="btn btn-sm btn-primary fw-bold me-1" onclick="window.abrirLancamento('${doc.id}')" title="Play"><i class="bi bi-play-fill"></i></button>
                <button class="btn btn-sm btn-outline-secondary border-0 me-1" onclick="window.abrirModalEdicaoRodada('${doc.id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="window.excluirRodada('${doc.id}')"><i class="bi bi-trash"></i></button>` : '';

              const btnView = `<button class="btn btn-sm btn-info border-0 me-1" onclick="window.abrirLancamento('${doc.id}', true)" title="Visualizar"><i class="bi bi-eye"></i></button>`;

              html += `
                <tr>
                    <td class="fw-bold text-muted">${r.numero}</td>
                    <td>${new Date(r.data + "T12:00").toLocaleDateString('pt-BR')}</td>
                    <td><span class="badge ${badge} rounded-pill">${r.tipo}</span></td>
                    <td class="border-start text-success fw-bold">R$ ${r.buyInValor}</td>
                    <td class="text-muted small">${r.buyInFichas}</td>
                    <td class="border-start">R$ ${r.rebuyValor}</td>
                    <td class="text-muted small">${r.rebuyFichas}</td>
                    <td class="border-start">R$ ${r.addOnValor}</td>
                    <td class="text-muted small">${r.addOnFichas}</td>
                    <td class="border-start text-warning fw-bold">${r.bonusFichas>0?r.bonusFichas:'-'}</td>
                    <td class="text-end">
                        ${btnView}
                        ${btnsGestor}
                    </td>
                </tr>
              `;
          });
          document.getElementById('tabelaRodadas').innerHTML = html || '<tr><td colspan="11" class="p-4 text-muted">Nenhuma rodada cadastrada.</td></tr>';
      });
  }

  window.abrirModalEdicaoRodada = async (id = null) => {
      document.getElementById('formRodada').reset();
      document.getElementById('rodadaEditId').value = id || '';
      const btn = document.getElementById('btnSalvarRodada');
      
      if (id) {
          btn.innerText = "Atualizar";
          const r = (await getDoc(doc(db, "rankings", currentRankingId, "rodadas", id))).data();
          document.getElementById('rodNumero').value = r.numero;
          document.getElementById('rodData').value = r.data;
          document.getElementById('rodTipo').value = r.tipo;
          document.getElementById('rodBuyInValor').value = r.buyInValor;
          document.getElementById('rodBuyInFichas').value = r.buyInFichas;
          document.getElementById('rodRebuyValor').value = r.rebuyValor;
          document.getElementById('rodRebuyFichas').value = r.rebuyFichas;
          document.getElementById('rodAddOnValor').value = r.addOnValor;
          document.getElementById('rodAddOnFichas').value = r.addOnFichas;
          document.getElementById('rodBonusFichas').value = r.bonusFichas;
      } else {
          btn.innerText = "Salvar";
          document.getElementById('rodNumero').value = nextRodadaNumero;
          document.getElementById('rodData').value = new Date().toISOString().split('T')[0];
          document.getElementById('rodTipo').value = 'Cash';
          window.aplicarPreSets();
      }
      modalNovaRodada.show();
  };
  
  window.fecharModalNovaRodada = () => modalNovaRodada.hide();
  
  window.aplicarPreSets = () => {
      if (document.getElementById('rodTipo').value === 'Cash') {
          document.getElementById('rodBuyInValor').value = 10; document.getElementById('rodBuyInFichas').value = 10;
          document.getElementById('rodRebuyValor').value = 10; document.getElementById('rodRebuyFichas').value = 10;
          document.getElementById('rodAddOnValor').value = 0; document.getElementById('rodAddOnFichas').value = 0;
          document.getElementById('rodBonusFichas').value = 0;
      } else {
          document.getElementById('rodBuyInValor').value = 20; document.getElementById('rodBuyInFichas').value = 20000;
          document.getElementById('rodRebuyValor').value = 20; document.getElementById('rodRebuyFichas').value = 20000;
          document.getElementById('rodAddOnValor').value = 30; document.getElementById('rodAddOnFichas').value = 30000;
          document.getElementById('rodBonusFichas').value = 5000;
      }
  };

  document.getElementById('formRodada').addEventListener('submit', async (e) => {
      e.preventDefault(); 
      if(!currentRankingId) return;
      const editId = document.getElementById('rodadaEditId').value;
      const dados = {
          numero: parseInt(document.getElementById('rodNumero').value),
          data: document.getElementById('rodData').value,
          tipo: document.getElementById('rodTipo').value,
          buyInValor: parseFloat(document.getElementById('rodBuyInValor').value)||0,
          buyInFichas: parseInt(document.getElementById('rodBuyInFichas').value)||0,
          rebuyValor: parseFloat(document.getElementById('rodRebuyValor').value)||0,
          rebuyFichas: parseInt(document.getElementById('rodRebuyFichas').value)||0,
          addOnValor: parseFloat(document.getElementById('rodAddOnValor').value)||0,
          addOnFichas: parseInt(document.getElementById('rodAddOnFichas').value)||0,
          bonusFichas: parseInt(document.getElementById('rodBonusFichas').value)||0,
          criadoEm: new Date().toISOString()
      };
      
      try {
          if (editId) await updateDoc(doc(db, "rankings", currentRankingId, "rodadas", editId), dados);
          else await addDoc(collection(db, "rankings", currentRankingId, "rodadas"), { ...dados, criadoEm: new Date().toISOString() });
          modalNovaRodada.hide();
      } catch (e) { alert("Erro: " + e.message); }
  });

  window.excluirRodada = async (id) => {
      if(confirm("Excluir esta rodada?")) await deleteDoc(doc(db, "rankings", currentRankingId, "rodadas", id));
  };

  // ========================================================
  // MODULO 5: CONFIGURAÇÃO DE RANKINGS
  // ========================================================
  window.addLinhaC = (p='', v='') => {
      document.getElementById('container-c').insertAdjacentHTML('beforeend', 
      `<div class="input-group input-group-sm mb-1 row-c">
          <span class="input-group-text" style="width:40px;justify-content:center">#</span>
          <input type="number" class="form-control inp-pos" placeholder="Pos" value="${p}">
          <span class="input-group-text">=</span>
          <input type="number" class="form-control inp-pts" placeholder="Pts" value="${v}">
          <span class="input-group-text btn-remove-row" onclick="this.parentElement.remove()">x</span>
      </div>`);
  };
  window.addLinhaFj = (q='', f='') => {
      document.getElementById('container-fj').insertAdjacentHTML('beforeend',
      `<div class="row g-1 mb-1 row-fj align-items-center">
          <div class="col-5"><input type="number" class="form-control form-control-sm inp-qtd" placeholder="Qtd" value="${q}"></div>
          <div class="col-5"><input type="number" step="0.01" class="form-control form-control-sm inp-fat" placeholder="Fator" value="${f}"></div>
          <div class="col-2 text-center"><span class="btn-remove-row" onclick="this.parentElement.parentElement.remove()">x</span></div>
      </div>`);
  };
  window.addLinhaFb = (v='', f='') => {
      document.getElementById('container-fb').insertAdjacentHTML('beforeend',
      `<div class="row g-1 mb-1 row-fb align-items-center">
          <div class="col-5"><input type="number" class="form-control form-control-sm inp-val" placeholder="$" value="${v}"></div>
          <div class="col-5"><input type="number" step="0.01" class="form-control form-control-sm inp-fat" placeholder="Fator" value="${f}"></div>
          <div class="col-2 text-center"><span class="btn-remove-row" onclick="this.parentElement.parentElement.remove()">x</span></div>
      </div>`);
  };
  window.addLinhaP=(p='', pct='')=>{
      document.getElementById('container-p').insertAdjacentHTML('beforeend',
      `<div class="row g-1 mb-1 row-p align-items-center">
          <div class="col-5"><div class="input-group input-group-sm"><span class="input-group-text">#</span><input type="number" class="form-control inp-pos" placeholder="Pos" value="${p}"></div></div>
          <div class="col-5"><div class="input-group input-group-sm"><input type="number" step="0.1" class="form-control inp-pct" placeholder="%" value="${pct}"><span class="input-group-text">%</span></div></div>
          <div class="col-2 text-center"><span class="btn-remove-row" onclick="this.parentElement.parentElement.remove()">x</span></div>
      </div>`)
  };

  window.abrirModalRanking = async (id) => {
      document.getElementById('formRanking').reset(); document.getElementById('rankingEditId').value = id || '';
      ['c','fj','fb','p'].forEach(k => document.getElementById('container-'+k).innerHTML='');
      
      const setFormState = (d) => {
          document.getElementById('rankNome').disabled = d; document.getElementById('rankBase').disabled = d;
          document.querySelectorAll('#content-conf input, #content-premio input').forEach(i => i.disabled = d);
          document.querySelectorAll('.btn-add-row,.btn-remove-row').forEach(b => b.style.display = d ? 'none' : 'block');
          document.getElementById('alertRankingLocked').classList.toggle('d-none', !d);
      };

      if (id) {
          const r = (await getDoc(doc(db, "rankings", id))).data();
          let st = r.status || (r.ativo ? 'Ativo' : 'Finalizado');
          document.getElementById('rankNome').value = r.nome;
          document.getElementById('rankStatus').value = st;
          document.getElementById('rankBase').value = r.sistemaPontuacao.base_c;
          (r.sistemaPontuacao.tabela_c||[]).forEach(i => window.addLinhaC(i.pos, i.pts));
          (r.sistemaPontuacao.tabela_fj||[]).forEach(i => window.addLinhaFj(i.qtd, i.fator));
          (r.sistemaPontuacao.tabela_fb||[]).forEach(i => window.addLinhaFb(i.buyin, i.fator));
          (r.distribuicao_premios||[]).forEach(i => window.addLinhaP(i.pos, i.pct));
          setFormState(st !== 'Rascunho');
      } else {
          document.getElementById('rankStatus').value = 'Rascunho';
          setFormState(false);
          for(let i=1;i<=10;i++) window.addLinhaC(i,"");
          window.addLinhaFj(10,1.0); window.addLinhaFb(20,1.0);
          window.addLinhaP(1, 40); window.addLinhaP(2, 25); window.addLinhaP(3, 19); window.addLinhaP(4, 10); window.addLinhaP(5, 6);
      }
      modalRanking.show();
  };

  document.getElementById('formRanking').addEventListener('submit', async (e) => {
      e.preventDefault(); 
      if(!currentUser || (currentUser.role!=='admin'&&currentUser.role!=='manager')) return alert("Sem permissão");
      
      const tabC=[], tabFj=[], tabFb=[], tabP=[];
      
      document.querySelectorAll('.row-c').forEach(d => {
          if(d.querySelector('.inp-pos').value) tabC.push({pos: parseInt(d.querySelector('.inp-pos').value), pts: parseFloat(d.querySelector('.inp-pts').value)});
      });
      document.querySelectorAll('.row-fj').forEach(d => {
          if(d.querySelector('.inp-qtd').value) tabFj.push({qtd: parseInt(d.querySelector('.inp-qtd').value), fator: parseFloat(d.querySelector('.inp-fat').value)});
      });
      document.querySelectorAll('.row-fb').forEach(d => {
          if(d.querySelector('.inp-val').value) tabFb.push({buyin: parseInt(d.querySelector('.inp-val').value), fator: parseFloat(d.querySelector('.inp-fat').value)});
      });
      document.querySelectorAll('.row-p').forEach(d => {
          if(d.querySelector('.inp-pos').value) tabP.push({pos: parseInt(d.querySelector('.inp-pos').value), pct: parseFloat(d.querySelector('.inp-pct').value)});
      });
      
      const status = document.getElementById('rankStatus').value;
      const data = {
          nome: document.getElementById('rankNome').value,
          status, ativo: status === 'Ativo',
          sistemaPontuacao: { base_c: parseInt(document.getElementById('rankBase').value), tabela_c: tabC, tabela_fj: tabFj, tabela_fb: tabFb },
          distribuicao_premios: tabP
      };
      
      try {
          const id = document.getElementById('rankingEditId').value;
          if(id) await updateDoc(doc(db,"rankings",id), data);
          else await addDoc(collection(db,"rankings"), {...data, criadoEm: new Date().toISOString(), criadoPor: auth.currentUser.uid});
          modalRanking.hide();
      } catch(err) { alert(err.message); }
  });

  window.simularPontos = () => {
      const p = parseInt(document.getElementById('simPos').value);
      const q = parseInt(document.getElementById('simQtd').value);
      const b = parseInt(document.getElementById('simBuyIn').value);
      
      let c = parseInt(document.getElementById('rankBase').value);
      let fj = 1.0, fb = 1.0;
      
      document.querySelectorAll('.row-c').forEach(d => { if(parseInt(d.querySelector('.inp-pos').value) === p) c = parseFloat(d.querySelector('.inp-pts').value); });
      document.querySelectorAll('.row-fj').forEach(d => { if(parseInt(d.querySelector('.inp-qtd').value) === q) fj = parseFloat(d.querySelector('.inp-fat').value); });
      document.querySelectorAll('.row-fb').forEach(d => { if(parseInt(d.querySelector('.inp-val').value) === b) fb = parseFloat(d.querySelector('.inp-fat').value); });
      
      document.getElementById('simResultado').innerText = (c * fj * fb).toFixed(2);
  };

  window.copiarRanking = async (id) => {
      if(!confirm("Duplicar este ranking?")) return;
      const d = (await getDoc(doc(db, "rankings", id))).data();
      const n = prompt("Novo Nome:", "Cópia " + d.nome);
      if(n) await addDoc(collection(db, "rankings"), { ...d, nome: n, status: 'Rascunho', ativo: false, criadoEm: new Date().toISOString(), criadoPor: auth.currentUser.uid });
  };

  window.excluirRanking = async (id) => {
      if(confirm("Excluir definitivamente?")) await deleteDoc(doc(db, "rankings", id));
  };

  // ========================================================
  // MODULO 6: RELATÓRIOS & CLASSIFICAÇÃO
  // ========================================================
  window.verClassificacao = async (rankingId, nomeRanking) => {
      document.getElementById('tituloClassificacao').innerText = `Classificação: ${nomeRanking}`;
      document.getElementById('bodyClassificacao').innerHTML = '<tr><td class="p-5">Carregando...</td></tr>';
      modalClassificacao.show();

      try {
          const rankDoc = await getDoc(doc(db, "rankings", rankingId));
          const rankingData = rankDoc.data();
          const regrasPremio = rankingData.distribuicao_premios || [];

          const rodadasRef = collection(db, "rankings", rankingId, "rodadas");
          const qRodadas = query(rodadasRef, orderBy("numero", "asc"));
          const snapRodadas = await getDocs(qRodadas);
          
          let rodadas = []; 
          let masterData = {};
          let totalSobras = 0, totalTaxas = 0, totalRetidoTorneio = 0;

          for (const docRodada of snapRodadas.docs) {
              const rData = docRodada.data();
              rodadas.push(rData.numero);
              
              let rodadaTotalInv = 0;
              let rodadaTotalPag = 0;

              const resSnap = await getDocs(collection(db, "rankings", rankingId, "rodadas", docRodada.id, "jogadores"));
              
              resSnap.forEach(res => {
                  const p = res.data();
                  const nick = p.apelido;
                  
                  if (!masterData[nick]) {
                      masterData[nick] = { nome: nick, total: 0, rodadas: {} };
                  }
                  
                  const pts = parseFloat(p.pontos)||0;
                  masterData[nick].total += pts;
                  masterData[nick].rodadas[rData.numero] = pts;

                  totalTaxas += (parseFloat(p.taxa)||0);
                  totalSobras += (parseFloat(p.sobras)||0);

                  if (rData.tipo === 'Torneio') {
                      rodadaTotalInv += (parseFloat(p.investimento)||0);
                      rodadaTotalPag += (parseFloat(p.saida)||0);
                  }
              });

              if (rData.tipo === 'Torneio') {
                  const retencao = rodadaTotalInv - rodadaTotalPag;
                  if (retencao > 0) totalRetidoTorneio += retencao;
              }
          }

          let rankingFinal = Object.values(masterData).sort((a, b) => b.total - a.total);
          let headerHtml = '<th class="bg-dark text-white" style="width:50px">#</th><th class="bg-dark text-white text-start">Nome</th><th class="bg-warning text-dark fw-bold">Total</th>';
          rodadas.forEach(r => { headerHtml += `<th class="th-rodada">${r}</th>`; });
          document.getElementById('headerClassificacao').innerHTML = headerHtml;

          let bodyHtml = '';
          rankingFinal.forEach((p, index) => {
              const pos = index + 1;
              let classRank = pos===1?'rank-1':(pos===2?'rank-2':(pos===3?'rank-3':''));
              let row = `<tr class="${classRank}"><td>${pos}º</td><td class="text-start">${p.nome}</td><td class="td-pontos">${p.total.toFixed(2)}</td>`;
              rodadas.forEach(r => {
                  const pts = p.rodadas[r] !== undefined ? p.rodadas[r].toFixed(1) : '-';
                  row += `<td>${pts}</td>`;
              });
              bodyHtml += row + '</tr>';
          });
          document.getElementById('bodyClassificacao').innerHTML = bodyHtml || '<tr><td colspan="100" class="p-5">Sem dados.</td></tr>';

          const totalCaixaGeral = totalSobras + totalTaxas + totalRetidoTorneio;
          document.getElementById('financeiroTotal').innerText = "R$ " + totalCaixaGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2});
          document.getElementById('financeiroDetalhes').innerHTML = `
            <li class="d-flex justify-content-between"><span>(+) Sobras (Cash):</span> <b>${totalSobras.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</b></li>
            <li class="d-flex justify-content-between"><span>(+) Taxas:</span> <b>${totalTaxas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</b></li>
            <li class="d-flex justify-content-between"><span>(+) Retido (Torneios):</span> <b>${totalRetidoTorneio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</b></li>
          `;
          
          let htmlPremios = '';
          if(regrasPremio.length > 0) {
              regrasPremio.forEach(regra => {
                  const valor = totalCaixaGeral * (regra.pct / 100);
                  htmlPremios += `<li class="list-group-item d-flex justify-content-between align-items-center"><span><span class="badge bg-dark rounded-pill">${regra.pos}º</span> ${regra.pct}%</span><span class="fw-bold text-success">R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></li>`;
              });
          } else {
              htmlPremios = '<li class="list-group-item text-danger small">Nenhuma regra de prêmio configurada na Temporada.</li>';
          }
          document.getElementById('listaPremiacaoProjetada').innerHTML = htmlPremios;

      } catch (e) { console.error(e); }
  };

  window.abrirRelatorioFinanceiro = async (rankingId) => {
      currentRankingId = rankingId;
      const selFiltro = document.getElementById('selFiltroRodadaFinanceiro');
      selFiltro.innerHTML = '<option value="todos">Geral (Acumulado)</option><option disabled>Carregando...</option>';
      document.getElementById('relatorioTotalRetido').innerText = 'Calculando...';
      modalRelatorioFinanceiro.show();

      const rodadasRef = collection(db, "rankings", rankingId, "rodadas");
      const qRodadas = query(rodadasRef, orderBy("numero", "asc"));
      const snapRodadas = await getDocs(qRodadas);
      
      selFiltro.innerHTML = '<option value="todos">Geral (Acumulado)</option>';
      let rodadasMap = {}; 
      let totalRetido = 0;

      financeiroCacheData = [];

      for (const docRodada of snapRodadas.docs) {
          const r = docRodada.data();
          const rID = docRodada.id;
          rodadasMap[rID] = { numero: r.numero, tipo: r.tipo };
          selFiltro.innerHTML += `<option value="${rID}">Rodada #${r.numero} (${r.tipo}) - ${new Date(r.data + 'T12:00').toLocaleDateString('pt-BR')}</option>`;
          
          let rodadaTotalInv = 0;
          let rodadaTotalPag = 0;

          const resSnap = await getDocs(collection(db, "rankings", rankingId, "rodadas", rID, "jogadores"));
          resSnap.forEach(res => {
              const p = res.data();
              financeiroCacheData.push({
                  rodadaId: rID,
                  rodadaNumero: r.numero,
                  rodadaTipo: r.tipo,
                  apelido: p.apelido,
                  investimento: parseFloat(p.investimento) || 0,
                  saida: parseFloat(p.saida) || 0, 
                  sobras: parseFloat(p.sobras) || 0,
                  cashout: parseFloat(p.cashout) || 0, 
                  taxa: parseFloat(p.taxa) || 0
              });
              if (r.tipo === 'Torneio') {
                  rodadaTotalInv += parseFloat(p.investimento) || 0;
                  rodadaTotalPag += parseFloat(p.saida) || 0;
              }
          });
          if (r.tipo === 'Torneio') {
              const retencao = rodadaTotalInv - rodadaTotalPag;
              if (retencao > 0) totalRetido += retencao;
          }
      }
      
      document.getElementById('relatorioTotalRetido').innerText = "R$ " + totalRetido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
      filtrarRelatorioFinanceiro();
  };

  window.filtrarRelatorioFinanceiro = () => {
      const filtro = document.getElementById('selFiltroRodadaFinanceiro').value;
      const tbody = document.getElementById('tbodyRelatorioFinanceiro');
      const tfoot = document.getElementById('tfootRelatorioFinanceiro');
      
      let mapJogadores = {}; 
      let totaisGerais = { inv: 0, fichas: 0, sobras: 0, cashout: 0, taxa: 0, balanco: 0 };

      financeiroCacheData.forEach(d => {
          if (filtro !== 'todos' && d.rodadaId !== filtro) return; 

          if (!mapJogadores[d.apelido]) {
              mapJogadores[d.apelido] = { apelido: d.apelido, inv: 0, fichas: 0, sobras: 0, cashout: 0, taxa: 0 };
          }

          const j = mapJogadores[d.apelido];
          j.inv += d.investimento;
          j.fichas += d.saida; 
          j.sobras += d.sobras;
          j.taxa += d.taxa;

          let valLiquido = 0;
          if (d.rodadaTipo === 'Cash') {
              valLiquido = d.cashout; 
          } else {
              valLiquido = d.saida; 
          }
          j.cashout += valLiquido;
      });

      let html = '';
      const listaFinal = Object.values(mapJogadores).sort((a, b) => a.apelido.localeCompare(b.apelido));

      listaFinal.forEach(j => {
          const balanco = j.cashout - j.inv - j.taxa;
          totaisGerais.inv += j.inv;
          totaisGerais.fichas += j.fichas;
          totaisGerais.sobras += j.sobras;
          totaisGerais.cashout += j.cashout;
          totaisGerais.taxa += j.taxa;
          totaisGerais.balanco += balanco;

          const corBalanco = balanco >= 0 ? 'text-green' : 'text-red';

          html += `
            <tr>
                <td class="ps-3 fw-bold">${j.apelido}</td>
                <td class="td-money">${j.inv.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="td-money text-muted">${j.fichas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="td-money text-muted">${j.sobras.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="td-money fw-bold text-primary">${j.cashout.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="td-money text-warning text-dark">${j.taxa.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="td-money ${corBalanco}">${balanco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
          `;
      });

      if(listaFinal.length === 0) html = '<tr><td colspan="7" class="text-center p-4 text-muted">Nenhum dado encontrado.</td></tr>';
      tbody.innerHTML = html;

      tfoot.innerHTML = `
        <td class="text-start ps-3">TOTAIS</td>
        <td>${totaisGerais.inv.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${totaisGerais.fichas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${totaisGerais.sobras.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${totaisGerais.cashout.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${totaisGerais.taxa.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${totaisGerais.balanco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
      `;
  };

  // ========================================================
  // MODULO 7: INICIALIZAÇÃO E LISTENERS
  // ========================================================
  
  function iniciarListenerJogadores() {
      if (unsubscribePlayers) unsubscribePlayers();
      
      const sortBy = document.getElementById('selOrdenacaoJogadores')?.value || 'nome';
      const qP = query(collection(db, "jogadores"), orderBy(sortBy));
      
      unsubscribePlayers = onSnapshot(qP, (s) => {
          globalJogadoresData = [];
          s.forEach(d => { globalJogadoresData.push({ id: d.id, ...d.data() }); });
          renderizarTabelaJogadores();
          checarAniversariantes();
      });
  }

  document.getElementById('checkMostrarArquivados').addEventListener('change', () => {
      mostrarArquivados = document.getElementById('checkMostrarArquivados').checked;
      renderizarTabelaJogadores();
  });
  
  document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
          await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginSenha').value);
      } catch (e) { alert(e.message); }
  });
  
  document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

  // Monitor de Auth
  onAuthStateChanged(auth, async (u) => {
      if (u) {
          const d = await getDoc(doc(db, "jogadores", u.uid));
          if (d.exists()) {
              currentUser = d.data();
              document.getElementById('navUserInfo').innerText = `${currentUser.apelido} (${currentUser.role})`;
              document.getElementById('authContainer').classList.add('hidden');
              document.getElementById('appDashboard').classList.remove('hidden');
              document.getElementById('btnLogout').classList.remove('hidden');
              
              const isGestor = currentUser.role === 'admin' || currentUser.role === 'manager';
              if (isGestor) {
                  document.getElementById('btnNovoJogador').classList.remove('hidden');
                  document.getElementById('btnNovoRanking').classList.remove('hidden');
              }
              
              // Adiciona o listener para o seletor de ordenação
              document.getElementById('selOrdenacaoJogadores').addEventListener('change', iniciarListenerJogadores);
              
              // Inicia Listeners
              iniciarListenerJogadores();

              const qR = query(collection(db, "rankings"), orderBy("criadoEm", "desc"));
              unsubscribeRankings = onSnapshot(qR, (s) => {
                  iniciarListaRankings(s);
              });

          } else {
              alert("Erro: Usuário não encontrado no banco (Zumbi). Logout forçado.");
              await signOut(auth);
              location.reload();
          }
      } else {
          document.getElementById('authContainer').classList.remove('hidden');
          document.getElementById('appDashboard').classList.add('hidden');
      }
  });

</script>
</body>
</html>
